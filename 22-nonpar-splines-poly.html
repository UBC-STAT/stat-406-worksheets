<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="These notes accompany the lectures for UBC’s Stat 406.">

<title>UBC Stat 406 Worksheets - 7&nbsp; Non-parametric regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./23-kernel-regression.html" rel="next">
<link href="./21-lasso-elnet.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./20-ridge-regression.html">Module 2 - Regression</a></li><li class="breadcrumb-item"><a href="./22-nonpar-splines-poly.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Non-parametric regression</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">UBC Stat 406 Worksheets</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ubc-stat/stat-406-worksheets" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Module 0 - Review</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-lm-diagnostics-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Predictions using a linear model</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Module 1 - Model selection</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-test-set-and-cv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Predictions using a linear model (continued)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-cv-concerns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation concerns</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-model-selection-aic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Comparing models</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Module 2 - Regression</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-ridge-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Ridge regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-lasso-elnet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">LASSO</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22-nonpar-splines-poly.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Non-parametric regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23-kernel-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Kernel regression / local regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24-trees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Regression trees</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25-more-trees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Pruning regression trees with <code>rpart</code></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Module 3 - Classification</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30-lda-logit.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Parametric classifiers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31-qda-knn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">QDA</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32-class-trees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Classification Trees</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Module 4 - Modern techniques</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./40-bagging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Bagging for regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./41-bagging-classifiers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Bagging for classification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./42-random-forests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Random Forests</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./43-boosting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Boosting (a Statistical Learning perspective)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./44-adaboost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">What is Adaboost doing, <em>really</em>?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./45-single-layer-nn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Single layer neural network</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Module 5 - Unsupervised learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./51-pca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52-kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Clustering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53-model-based-clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Model based clustering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54-hclust.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Hierarchical clustering</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./80-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./90-pca-alternating-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">PCA and alternating regression</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#polynomial-regression" id="toc-polynomial-regression" class="nav-link active" data-scroll-target="#polynomial-regression"><span class="header-section-number">7.1</span> Polynomial regression</a></li>
  <li><a href="#a-more-stable-basis-splines" id="toc-a-more-stable-basis-splines" class="nav-link" data-scroll-target="#a-more-stable-basis-splines"><span class="header-section-number">7.2</span> A more stable basis: splines</a></li>
  <li><a href="#higher-order-splines-quadratic-cubic-etc." id="toc-higher-order-splines-quadratic-cubic-etc." class="nav-link" data-scroll-target="#higher-order-splines-quadratic-cubic-etc."><span class="header-section-number">7.3</span> Higher order splines (quadratic, cubic, etc.)</a></li>
  <li><a href="#how-many-knots-should-we-use" id="toc-how-many-knots-should-we-use" class="nav-link" data-scroll-target="#how-many-knots-should-we-use"><span class="header-section-number">7.4</span> How many knots should we use?</a></li>
  <li><a href="#smoothing-splines" id="toc-smoothing-splines" class="nav-link" data-scroll-target="#smoothing-splines"><span class="header-section-number">7.5</span> Smoothing splines</a></li>
  <li><a href="#selecting-an-optimal-penalty-parameter" id="toc-selecting-an-optimal-penalty-parameter" class="nav-link" data-scroll-target="#selecting-an-optimal-penalty-parameter"><span class="header-section-number">7.6</span> Selecting an “optimal” penalty parameter</a>
  <ul class="collapse">
  <li><a href="#sanity-check-always-a-good-idea" id="toc-sanity-check-always-a-good-idea" class="nav-link" data-scroll-target="#sanity-check-always-a-good-idea"><span class="header-section-number">7.6.1</span> Sanity check (always a good idea)</a></li>
  </ul></li>
  <li><a href="#the-problem-of-outliers-and-other-model-departures" id="toc-the-problem-of-outliers-and-other-model-departures" class="nav-link" data-scroll-target="#the-problem-of-outliers-and-other-model-departures"><span class="header-section-number">7.7</span> The problem of outliers and other model departures</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/ubc-stat/stat-406-worksheets/blob/main/22-nonpar-splines-poly.qmd" class="toc-action">View source</a></p><p><a href="https://github.com/ubc-stat/stat-406-worksheets/edit/main/22-nonpar-splines-poly.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/ubc-stat/stat-406-worksheets/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Non-parametric regression</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>We now turn our attention to the situation where the regression function E(Y|X) is not necessarily linear. Furthermore, we will assume that its <em>form</em> is <strong>unknown</strong>. If we knew that the regression function was a linear combination of a sine and a cosine function, “E(Y|X=x) = a + b sin(x) + c cos(x)”, where <em>a</em>, <em>b</em> and <em>c</em> are uknown, for example, then the problem would in fact be a linear regression problem. More in general, when the true regression function is known (or assumed) to belong to a family of functions that we can parametrize, then the estimation can be done via standard least squares. Instead here we focus on the case where the regression function is <strong>completely unknown</strong>.</p>
<p>In this note and the next one will discuss two ways to estimating <span class="math inline">\(E(Y|X)\)</span>:</p>
<ol type="a">
<li>one using bases (e.g.&nbsp;a polynomial basis, or a spline basis); and</li>
<li>one using kernels (aka local regression).</li>
</ol>
<p>To simplify the presentation (but also because of an intrinsic limitation of these methods, which will be discussed in more detail later in the course), we will initially only consider the case where there is a single explanatory variable (i.e.&nbsp;X above is a scalar, not a vector).</p>
<section id="polynomial-regression" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="polynomial-regression"><span class="header-section-number">7.1</span> Polynomial regression</h2>
<p>To illustrate these basis methods, we will consider the <code>lidar</code> data, available in the package <code>SemiPar</code>. More information is available from the corresponding help page: <code>help(lidar, package='SemiPar')</code>. We now load the data and plot it, the response variable is <code>logratio</code> and the explanatory one is <code>range</code>:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/nonparam_c87b5aed0a46c6bb5645885709a0cc71">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(lidar, <span class="at">package =</span> <span class="st">"SemiPar"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/nonparam-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>In class we discussed the formal motivation to look into a polynomial approximation of the regression function. This argument, however, does not specify which degree of the approximating polynomial to use. Here we first try a 4th degree polynomial and the problem reduces to a linear regression one (see the lecture slides). We can use a command like <code>lm(logratio ~ range + range^2 + range^3 + range^4)</code>. However, this call to <code>lm</code> will not work as we intend it (I recommend that you check this and find out the reason why). Instead, we would need to use something like <code>lm(logratio ~ range + I(range^2) + I(range^3) + I(range^4))</code>. To avoid having to type a long formula, we can instead use the function <code>poly()</code> in <code>R</code> to generate the design matrix containing the desired powers of <code>range</code>, and plug that into the call to <code>lm()</code>. The code below fits two such approximations (a 3rd degree and a 4th degree polynomial), plots the data and overlays the estimated regression function:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/poly4_e659530902ef4122134d025f6ab6482c">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Degree 4 polynomials</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pm <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">poly</span>(range, <span class="dv">4</span>), <span class="at">data =</span> lidar)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(pm)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>pm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">poly</span>(range, <span class="dv">3</span>), <span class="at">data =</span> lidar)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(pm3)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"hotpink"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"3rd degree"</span>, <span class="st">"4th degree"</span>), <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"hotpink"</span>, <span class="st">"blue"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/poly4-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Note that this fit is reasonable, although there is probably room for improvement. Based on the formal motivation discussed in class to use polynomials in the first place, it may seem natural to increase the order of the approximating polynomial in order to improve the quality of the approximation. However, this is easily seen not to be a good idea. Below we compare the 4th degree approximation used above (in blue) with a 10th degree one (in red):</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/poly10_df725a2635ad31d1b4b4f9e13c27a060">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Degree 10 polynomials</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">poly</span>(range, <span class="dv">10</span>), <span class="at">data =</span> lidar)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(pm)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(pm2)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/poly10-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Note that the 10th order fit follows the data much more closely, but it starts to become “too adaptive” and departing quite often from the main (larger scale) trend we associate with the regression (conditional mean) function.</p>
<p>(Can you explain the discrepancy between what we observe above and the motivation we used in class, that suggests that higher order polynomials provide better approximations?)</p>
</section>
<section id="a-more-stable-basis-splines" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="a-more-stable-basis-splines"><span class="header-section-number">7.2</span> A more stable basis: splines</h2>
<p>Part of the problem with global polynomial bases as the ones used above is that they necessarily become more wiggly within the range of the data, and also quickly increase or decrease near the edge of the observations. A more stable but also remarkably flexible basis is given by spline functions, as discussed in class.</p>
<p>We first here show how to build a naive linear spline basis with 5 knots (placed at the <code>(1:5)/6</code> quantiles (i.e.&nbsp;the 0.17, 0.33, 0.5, 0.67, 0.83 percentiles) of the observed values of the explanatory variable), and use it to estimate the regression function. Remember that a linear spline function with knot <em>w</em> is given by <code>f_w(x) = max( x - w, 0 )</code>. Given a fixed set of pre-selected knots <em>w_1</em>, <em>w_2</em>, …, <em>w_k</em>, we consider regression functions that are linear combinations of the corresponding k linear spline functions.</p>
<p>Note that for higher-order splines (e.g.&nbsp;cubic splines discussed below), the naive spline basis used above is numerically very unstable, and usually works poorly in practice. I include it here simply as an illustration of the methodology and to stress the point that this type of approach (that estimates the regression function as a linear combination of an explicit basis) is in fact nothing more than slightly more complex linear models.</p>
<p>First we find the 5 knots mentioned above that will be used to construct the spline basis:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/knots_060e21ebe547de2e69e310484710fca7">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select the knots at 5 specific quantiles</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>(kn <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(lidar<span class="sc">$</span>range, (<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">/</span> <span class="dv">6</span>)))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 444.6667 499.6667 555.0000 609.6667 664.6667</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we compute the matrix of “explanatory variables”, that is: the matrix that in its columns has each of the 5 basis functions <em>f_1</em>, <em>f_2</em>, …, <em>f_5</em> evaluated at the n observed values of the (single) explanatory variable <em>x_1</em>, …, <em>x_n</em>. In other words, the matrix <strong>X</strong> has in its <em>(i, j)</em> cell the value <em>f_j(x_i)</em>, for <em>j=1</em>, …, <em>k</em>, and <em>i=1</em>, …, <em>n</em>. In the code below we use (abuse?) <code>R</code>’s <em>recycling</em> rules when operating over vectors and arrays (can you spot it?)</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/linearbasis_be0967ed89fa4f0d61a54a20bc3bd147">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare the matrix of covariates / explanatory variables</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">dim</span>(lidar)[<span class="dv">1</span>], <span class="fu">length</span>(kn) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(kn)) {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    x[, j] <span class="ot">&lt;-</span> <span class="fu">pmax</span>(lidar<span class="sc">$</span>range <span class="sc">-</span> kn[j], <span class="dv">0</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>x[, <span class="fu">length</span>(kn) <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> lidar<span class="sc">$</span>range</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have the matrix of our “explanatory variables”, we can simply use <code>lm</code> to estimate the coefficients of the linear combination of the functions in the spline basis that will provide our regression function estimator. We then plot the data and overlay the fitted / estimated regression function:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/splines1_c75fa5e6948bfa6d504375273d99d9af">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the regression model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ppm <span class="ot">&lt;-</span> <span class="fu">lm</span>(lidar<span class="sc">$</span>logratio <span class="sc">~</span> x)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppm)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"hotpink"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/splines1-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>There are better (numerically more stable) bases for the same linear space spanned by these spline functions. These bases have different numerical properties and can become cumbersome to describe. Here we use the function <code>bs</code> (in package <code>splines</code>) to build a B-spline basis. For an accessible discussion, see for example <span class="citation" data-cites="wood2017generalized">(<a href="80-references.html#ref-wood2017generalized" role="doc-biblioref">Wood 2017, sec. 4.1</a>)</span>.</p>
<p>Given the chosen knots and the degree of the splines (linear, quadratic, cubic, etc.) the set (linear space) of functions we are using to construct our regression estimate does not depend on the specific basis we use (in other words: these are different bases that span the same linear space of functions). As a consequence, the estimated regression function should be the same regardless of the basis we use (provided we do not run into serious numerical issues with our naive basis). To illustrate this fact, we will use a B-spline basis with the same 5 knots as above, and compare the estimated regression function with the one we obtained above using our <strong>poor people naive basis</strong>. The plot below overlays both fits (the naive one with a thick pink line as above, and the one using b-splines with a thinner blue line):</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines1_f12fb21f8d3410a93a667d72406c9efc">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ppm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">bs</span>(range, <span class="at">degree =</span> <span class="dv">1</span>, <span class="at">knots =</span> kn), <span class="at">data =</span> lidar)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppm)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">8</span>, <span class="at">col =</span> <span class="st">"hotpink"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppm2)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"darkblue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/bsplines1-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>As expected, both fits provide the same estimated regression function, although its coefficients are naturally different (<strong>but their lengths are the same</strong>, is this a coincidence, or will it always happen?)</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines.coef_248808bdf4961849d9b47d843a253a2a">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.vector</span>(<span class="fu">coef</span>(ppm))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1]  0.0269095640  0.0002488169 -0.0003235802 -0.0082773735  0.0063779378</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [6]  0.0007385513 -0.0001847752</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">as.vector</span>(<span class="fu">coef</span>(ppm2))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] -0.04515276 -0.01010104 -0.00657875 -0.02093988 -0.48762440 -0.60636798</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [7] -0.68496471</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that, because we are using a set of linear splines, our estimated regression functions will always be piecewise linear (i.e.&nbsp;linear functions between each pair of knots). To obtain smoother (e.g.&nbsp;differentiable, continuously differentiable, or even twice continously differentiable) regression estimators below we will use higher-order splines.</p>
</section>
<section id="higher-order-splines-quadratic-cubic-etc." class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="higher-order-splines-quadratic-cubic-etc."><span class="header-section-number">7.3</span> Higher order splines (quadratic, cubic, etc.)</h2>
<p>In what follows (as above) we will use the function <code>bs</code> to evaluate the desired spline basis on the observed values of the explanatory variable (in this case <code>range</code>).</p>
<p>We use the arguments <code>degree = 2</code> and <code>knots = kn</code> to indicate we want a quadratic spline basis with knots located at the elements of the vector <code>kn</code>. As before, we then simply use <code>lm</code> to estimate the coefficients, and overlay the estimated regression function over the data:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines2_f42abd5c70e04924660d9588f4853fe2">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ppmq <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">bs</span>(range, <span class="at">degree =</span> <span class="dv">2</span>, <span class="at">knots =</span> kn), <span class="at">data =</span> lidar)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppmq)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"steelblue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/bsplines2-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>A useful consequence of the fact that these regression estimators are in fact just linear regression estimators (but using a richer / more flexible basis than just the straight predictors) is that we can easily compute (pointwise) standard errors for the fitted regression curve, as follows. We first fit and plot a quadratic spline using the same 5 knots as before:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines.se1_3383d1e3ac5ec4ef8d926784e75014ff">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ppmc <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">bs</span>(range, <span class="at">degree =</span> <span class="dv">2</span>, <span class="at">knots =</span> kn), <span class="at">data =</span> lidar)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppmc)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"gray30"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To compute the estimated standard error of the predicted regression curve on a grid of values of the explanatory variable <code>range</code>, we first build a grid of 200 equally spaced points within the observed scope of the variable <code>range</code>:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines.se2_cd0c2eaa8d14c18035d45dedc7628e3e">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(lidar<span class="sc">$</span>range), <span class="fu">max</span>(lidar<span class="sc">$</span>range), <span class="at">length =</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>predict</code> method for objects of class <code>lm</code> returns estimated standard errors for each fitted value if we set the argument <code>se.fit = TRUE</code>:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines.se3_9a88f5b409b4542ccd5395a797089521">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ppmc <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">bs</span>(range, <span class="at">degree =</span> <span class="dv">2</span>, <span class="at">knots =</span> kn), <span class="at">data =</span> lidar)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(ppmc, <span class="at">newdata =</span> <span class="fu">list</span>(<span class="at">range =</span> xx), <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now compute upper and lower confidence bands (I used 2 standard errors) around the fitted regression line:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines.se4_267711fe55f229b36c78c42a0a470417">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>up <span class="ot">&lt;-</span> (ps<span class="sc">$</span>fit <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> ps<span class="sc">$</span>se.fit)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>lo <span class="ot">&lt;-</span> (ps<span class="sc">$</span>fit <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> ps<span class="sc">$</span>se.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we display the <em>confidence bands</em> we just constructed (using <strong>base R</strong> graphics, but also consider using <code>ggplot2</code>):</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines.se5_a22321647edad7b54617088e952ee83d">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppmc)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">"gray30"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>myrgb <span class="ot">&lt;-</span> <span class="fu">col2rgb</span>(<span class="st">"red"</span>) <span class="sc">/</span> <span class="dv">256</span> <span class="co"># , alpha=TRUE)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>myrgb <span class="ot">&lt;-</span> <span class="fu">rgb</span>(<span class="at">red =</span> myrgb[<span class="dv">1</span>], <span class="at">green =</span> myrgb[<span class="dv">2</span>], <span class="at">blue =</span> myrgb[<span class="dv">3</span>], <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(xx, <span class="fu">rev</span>(xx)), <span class="fu">c</span>(up, <span class="fu">rev</span>(lo)), <span class="at">density =</span> <span class="cn">NA</span>, <span class="at">col =</span> myrgb) <span class="co">#' lightblue')</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ps<span class="sc">$</span>fit <span class="sc">~</span> xx, <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/bsplines.se5-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p><strong>It is important to note that the above confidence bands were constructed assuming that the knots were fixed (not random), and similarly for the degree of the spline basis.</strong></p>
<p>Increasing the degree of the cubic basis yields smoother fits (having higher order continuous derivatives). For example, using cubic splines yields an even smoother fit:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines3_b9bb94966abc63ef2adcdaf544745a7b">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cubic splines</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ppmc <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">bs</span>(range, <span class="at">degree =</span> <span class="dv">3</span>, <span class="at">knots =</span> kn), <span class="at">data =</span> lidar)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppmc)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"tomato3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/bsplines3-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Note that the estimated regression function seems to have started to “twitch” and wiggle, particularly at the upper end of our observations.</p>
</section>
<section id="how-many-knots-should-we-use" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="how-many-knots-should-we-use"><span class="header-section-number">7.4</span> How many knots should we use?</h2>
<p>So far we have used 5 knots, but we could have used any other number of knots. If we consider a quadratic spline basis with 10 knots, the fit appears a bit better (at least aesthetically):</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines.10knots_85ed17d8a3d84b6ff29b7dc829eacc73">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>kn <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(lidar<span class="sc">$</span>range, (<span class="dv">1</span><span class="sc">:</span>k)<span class="sc">/</span>(k <span class="sc">+</span> <span class="dv">1</span>)))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>ppmc <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">bs</span>(range, <span class="at">degree =</span> <span class="dv">2</span>, <span class="at">knots =</span> kn), <span class="at">data =</span> lidar)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppmc)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"tomato3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/bsplines.10knots-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>What about using more knots? The following plot used 50 knots:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/bsplines.50knots_ccbd99cca9108abfb18ed4040a098fab">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>kn <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(lidar<span class="sc">$</span>range, (<span class="dv">1</span><span class="sc">:</span>k) <span class="sc">/</span> (k <span class="sc">+</span> <span class="dv">1</span>)))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>ppmc <span class="ot">&lt;-</span> <span class="fu">lm</span>(logratio <span class="sc">~</span> <span class="fu">bs</span>(range, <span class="at">degree =</span> <span class="dv">2</span>, <span class="at">knots =</span> kn), <span class="at">data =</span> lidar)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">predict</span>(ppmc)[<span class="fu">order</span>(range)] <span class="sc">~</span> <span class="fu">sort</span>(range), <span class="at">data =</span> lidar, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"hotpink"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/bsplines.50knots-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Clearly not a good idea!</p>
</section>
<section id="smoothing-splines" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="smoothing-splines"><span class="header-section-number">7.5</span> Smoothing splines</h2>
<p>If we were to follow the approach discussed so far we would need to find an “optimal” of selecting the number of knots and their positions, <strong>plus</strong> the order of the spline basis. Although one could consider using cross-validation for this, we note that this would require considerable computational effort (we would need to perform an exhaustive search on a 3-dimensional grid).</p>
<p>We saw in class that <em>natural cubic splines</em> provide a natural <em>optimal</em> space to look for a good regression estimator. For a formal but surprisingly simple proof of this optimality result, see again Section 4.1 of</p>
<blockquote class="blockquote">
<p>Wood, S. (2006). <em>Generalized additive models : an introduction with R</em>. Chapman &amp; Hall/CRC, Boca Raton, FL. <a href="http://resolve.library.ubc.ca/cgi-bin/catsearch?bid=8140311">Library link</a>.</p>
</blockquote>
<p>This result not only justifies using natural cubic splines, but also eliminates many of the unknown “tuning parameters” (the degree of the spline basis, the number of knots, and their locations). In fact, we only need to select one tuning parameter–the penalty term, which can be done using any cross-validation “flavour” (although in this setting leave-one-out CV is particularly appealing, as we discussed in class).</p>
<p>The function <code>smooth.spline</code> in <code>R</code> computes a cubic smoothing spline (natural cubic spline). Details on its arguments and different options are available from its help page.</p>
<p>When applied to the <code>lidar</code> data with penalization parameter equal to 0.2 (setting the argument <code>spar = 0.2</code>) we obtain the following estimated regression function:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/smoothing1_af7dbe0d1a1d28b5593d356aa24510a6">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(<span class="at">x =</span> lidar<span class="sc">$</span>range, <span class="at">y =</span> lidar<span class="sc">$</span>logratio, <span class="at">spar =</span> <span class="fl">0.2</span>, <span class="at">cv =</span> <span class="cn">FALSE</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">all.knots =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tmp<span class="sc">$</span>y <span class="sc">~</span> tmp<span class="sc">$</span>x, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"magenta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/smoothing1-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This fit is clearly too wiggly and unsatisfactory. To obtain a smoother fit we increase the penalty term to 0.5:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/smoothing1.5_1fc3fd492e841d0d1c8ff5a7b9ca91f8">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(<span class="at">x =</span> lidar<span class="sc">$</span>range, <span class="at">y =</span> lidar<span class="sc">$</span>logratio, <span class="at">spar =</span> <span class="fl">0.5</span>, <span class="at">cv =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">all.knots =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tmp<span class="sc">$</span>y <span class="sc">~</span> tmp<span class="sc">$</span>x, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/smoothing1.5-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The larger the penalty parameter, the smoother the fit. Setting it to 0.8 yields:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/smoothing2_0c8ef80e0a79d7d371bbc9a0aa722552">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(<span class="at">x =</span> lidar<span class="sc">$</span>range, <span class="at">y =</span> lidar<span class="sc">$</span>logratio, <span class="at">spar =</span> <span class="fl">0.8</span>, <span class="at">cv =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">all.knots =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tmp<span class="sc">$</span>y <span class="sc">~</span> tmp<span class="sc">$</span>x, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/smoothing2-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>It is easy to see that the larger the penalty coefficient the closer the resulting natural cubic spline becomes to a linear function (why?). For example, if we use <code>smooth.spline(spar=2)</code>:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/smoothing3_6bc9e16f5f02593b34937f34ef425d3c">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(<span class="at">x =</span> lidar<span class="sc">$</span>range, <span class="at">y =</span> lidar<span class="sc">$</span>logratio, <span class="at">spar =</span> <span class="dv">2</span>, <span class="at">cv =</span> <span class="cn">FALSE</span>, <span class="at">all.knots =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tmp<span class="sc">$</span>y <span class="sc">~</span> tmp<span class="sc">$</span>x, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"tomato3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/smoothing3-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="selecting-an-optimal-penalty-parameter" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="selecting-an-optimal-penalty-parameter"><span class="header-section-number">7.6</span> Selecting an “optimal” penalty parameter</h2>
<p>As discussed in class, an “optimal” natural cubic spline can be found using cross-validation, and for these linear predictors, leave-one-out cross-validation is particularly attractive (in terms of computational cost). The function <code>smooth.spline</code> in <code>R</code> will compute (and use) an optimal value for the penalty term using leave-one-out cross-validation when we set the argument <code>cv = TRUE</code>:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/smoothing.cv1_db1fc73a86d1c88f7e5da60485be1ea5">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tmp.cv <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(<span class="at">x =</span> lidar<span class="sc">$</span>range, <span class="at">y =</span> lidar<span class="sc">$</span>logratio, <span class="at">cv =</span> <span class="cn">TRUE</span>, <span class="at">all.knots =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tmp.cv$spar = 0.974</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tmp.cv<span class="sc">$</span>y <span class="sc">~</span> tmp.cv<span class="sc">$</span>x, <span class="at">lwd =</span> <span class="dv">6</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/smoothing.cv1-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<section id="sanity-check-always-a-good-idea" class="level3" data-number="7.6.1">
<h3 data-number="7.6.1" class="anchored" data-anchor-id="sanity-check-always-a-good-idea"><span class="header-section-number">7.6.1</span> Sanity check (always a good idea)</h3>
<p>Note that the optimal value found for the regularization parameter (<code>spar</code>) is also returned in the element <code>$spar</code> of the object returned by <code>smooth.spline</code>. Just as a <strong>sanity check</strong> we can now call <code>smooth.spline</code> with <code>cv = FALSE</code> and manually set <code>spar</code> to this optimal value, and verify that we obtain the same fit:</p>
<div class="cell" data-layout-align="center" data-hash="22-nonpar-splines-poly_cache/html/smoothing.cv2_faa4bacd13db5ce7c238a702829b70d0">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(logratio <span class="sc">~</span> range, <span class="at">data =</span> lidar, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tmp.cv<span class="sc">$</span>y <span class="sc">~</span> tmp.cv<span class="sc">$</span>x, <span class="at">lwd =</span> <span class="dv">8</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(<span class="at">x =</span> lidar<span class="sc">$</span>range, <span class="at">y =</span> lidar<span class="sc">$</span>logratio, <span class="at">spar =</span> tmp.cv<span class="sc">$</span>spar, <span class="at">cv =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">all.knots =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tmp<span class="sc">$</span>y <span class="sc">~</span> tmp<span class="sc">$</span>x, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="22-nonpar-splines-poly_files/figure-html/smoothing.cv2-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-problem-of-outliers-and-other-model-departures" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="the-problem-of-outliers-and-other-model-departures"><span class="header-section-number">7.7</span> The problem of outliers and other model departures</h2>
<p>When the data may contain outliers and/or other atypical observations, the estimation methods discussed above may be seriously affected, even if there are only a few such aberrant data points in the training set (possible outliers in the test / validation set are also a concern, but we don’t have time to discuss it here). Some robust estimation methods based on splines exist. See for example <span class="citation" data-cites="TharmaratnamClaeskens2010">(<a href="80-references.html#ref-TharmaratnamClaeskens2010" role="doc-biblioref">Tharmaratnam et al. 2010</a>)</span> and references therein. Software in <code>R</code> implementing this method is available <a href="https://github.com/msalibian/PenalizedS">here</a>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-TharmaratnamClaeskens2010" class="csl-entry" role="listitem">
Tharmaratnam, Kukatharmini, Gerda Claeskens, Christophe Croux, and Matias Salibián-Barrera. 2010. <span>“S-Estimation for Penalized Regression Splines.”</span> <em>Journal of Computational and Graphical Statistics</em> 19 (3): 609–25. <a href="https://doi.org/10.1198/jcgs.2010.08149">https://doi.org/10.1198/jcgs.2010.08149</a>.
</div>
<div id="ref-wood2017generalized" class="csl-entry" role="listitem">
Wood, Simon N. 2017. <em>Generalized Additive Models: An Introduction with r</em>. CRC press.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./21-lasso-elnet.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">LASSO</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./23-kernel-regression.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Kernel regression / local regression</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">This work by <a href="https://dajmcdon.github.io">Daniel J. McDonald</a> and <a href="https://www.stat.ubc.ca/users/matias-salibian-barrera">Matías Salibián-Barrera</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>